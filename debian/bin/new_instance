#!/bin/sh

ROOTDIR=/opt/pysvnmanager/sites
DEFAULT_SITE=/opt/pysvnmanager/default

usage() {
    echo "Usage: new_instance <site_name>"
    exit 0
}

if [ $# -ne 1 ]; then
    usage
fi

SITE=$1
if [ ! ${SITE#-} = ${SITE} ]; then
    usage
fi

if [ -f /opt/pysvnmanager/virtualenv/bin/activate ]; then
  . /opt/pysvnmanager/virtualenv/bin/activate
fi

if paster -h >/dev/null 2>&1; then
    if [ ! -d $ROOTDIR/$SITE ]; then
        echo "Create site $ROOTDIR/$SITE ..."
        mkdir -p $ROOTDIR/$SITE/run
        mkdir -p $ROOTDIR/$SITE/db
        mkdir -p $ROOTDIR/$SITE/cgi-bin

        paster make-config pySvnManager $ROOTDIR/$SITE/production.ini && \
        paster setup-app $ROOTDIR/$SITE/production.ini\#myapp || true

        cp /opt/pysvnmanager/contrib/pysvnmanager.wsgi.in $ROOTDIR/$SITE/cgi-bin/pysvnmanager.wsgi
        sed -i -e "/^INSTANCE_DIR/ c INSTANCE_DIR   = \"$ROOTDIR/$SITE\"" $ROOTDIR/$SITE/cgi-bin/pysvnmanager.wsgi
        chmod a+x $ROOTDIR/$SITE/cgi-bin/pysvnmanager.wsgi

        chown -R www-data.www-data $ROOTDIR/$SITE

        if [ ! -f ${DEFAULT_SITE} ] && [ ! -d ${DEFAULT_SITE} ]; then
            echo "Link default site to $ROOTDIR/$SITE"
            ln -s $ROOTDIR/$SITE ${DEFAULT_SITE}
        fi
    else
        echo "Site: $SITE already exist!"
        exit 1
    fi
fi
