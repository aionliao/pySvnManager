From: Jiang <jiangxin@ossxp.com>
Subject: [PATCH] t/remote_user_login

If remote_user already defined, register login user.

Signed-off-by: Jiang <jiangxin@ossxp.com>

---
 pysvnmanager/controllers/security.py |   40 +++++++++++++++++++++++-----------
 1 files changed, 27 insertions(+), 13 deletions(-)

diff --git a/pysvnmanager/controllers/security.py b/pysvnmanager/controllers/security.py
index ded2193..ca29041 100644
--- a/pysvnmanager/controllers/security.py
+++ b/pysvnmanager/controllers/security.py
@@ -29,8 +29,29 @@ class SecurityController(BaseController):
         """
         Show login form. Submits to login/submit
         """
-        return render('/login/login.mako')
+        if request.environ.get("REMOTE_USER"):
+            self._session_register(request.environ["REMOTE_USER"])
+        return self._redirect()
 
+    def _redirect(self):
+        if session.get('user'):
+            # Send user back to the page he originally wanted to get to
+            if session.get('path_before_login'):
+                redirect(url(session['path_before_login']))
+            else: # if previous target is unknown just send the user to a welcome page
+                redirect(url(controller='check',action='index'))
+        else:
+            return render('/login/login.mako')
+
+    def _session_register(self, username):
+        session['user'] = username
+        log.info(_(u"User %s logged in") % session['user'])
+        session.save()
+
+    def _session_clear(self):
+        session.clear()
+        session.save()
+ 
     def submit(self):
         """
         Verify username and password
@@ -47,21 +68,14 @@ class SecurityController(BaseController):
         
         # Mark user as logged in
         if auth_passed:
-            session['user'] = username
-            log.info(_(u"User %s logged in") % session['user'])
-            session.save()
-
-            # Send user back to the page he originally wanted to get to
-            if session.get('path_before_login'):
-                redirect(url(session['path_before_login']))
-            else: # if previous target is unknown just send the user to a welcome page
-                redirect(url(controller='check',action='index'))
+            self._session_register(username)
         else:
             log.error("pySvnManager: User %s login failed from host [%s]" % ( username, request.remote_addr))
-            session.clear()
-            session.save()
+            self._session_clear()
             c.login_message = _(u"Login failed for user: %s") % username
-            return render('/login/login.mako')
+
+        # Do redirect
+        return self._redirect()
 
     def logout(self):
         """
-- 
tg: (f3aba2b..) t/remote_user_login (depends on: master)
